# â˜ï¸ EKS äº‘åŸç”Ÿé›†ç¾¤ç”Ÿå‘½å‘¨æœŸæµç¨‹æ–‡æ¡£

æœ¬é¡¹ç›®æ”¯æŒä½¿ç”¨ Terraform + eksctl + Bash è„šæœ¬ç»Ÿä¸€ç®¡ç† EKS é›†ç¾¤çš„æ¯æ—¥é”€æ¯ä¸é‡å»ºæµç¨‹ï¼Œå¹¶è‡ªåŠ¨æ¢å¤å…³é”®è¿è¡Œæ—¶é…ç½®ï¼ˆå¦‚ Spot Interruption SNS é€šçŸ¥ç»‘å®šï¼‰ã€‚æœ¬æ–‡ä»¶è®°å½•ä»åˆå§‹åŒ–åˆ°é”€æ¯çš„å…¨ç”Ÿå‘½å‘¨æœŸæ“ä½œæµç¨‹ï¼Œé€‚ç”¨äºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§æ¼”ç»ƒåœºæ™¯ã€‚

---

## ğŸ›  å‡†å¤‡å·¥ä½œ

### âœ… æœ¬åœ°ä¾èµ–è¦æ±‚

è¯·å…ˆç¡®ä¿æœ¬åœ°å·²å®‰è£…å¦‚ä¸‹å·¥å…·ï¼š

| å·¥å…·        | è¯´æ˜             |
| --------- | -------------- |
| AWS CLI   | ç”¨äºè´¦æˆ·æˆæƒä¸çŠ¶æ€æŸ¥è¯¢    |
| Terraform | IaC ä¸»å¼•æ“ï¼Œç®¡ç†èµ„æºå£°æ˜ |
| eksctl    | EKS æ§åˆ¶é¢è¾…åŠ©å·¥å…·    |
| Helm      | å¯é€‰ï¼Œç®¡ç†é›†ç¾¤å†…ç»„ä»¶     |

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥å·¥å…·ï¼š

```bash
make check
```

### âœ… AWS SSO ç™»å½•

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç™»å½• AWSï¼š

```bash
aws sso login --profile phase2-sso
```

---

## â˜€ é›†ç¾¤æ¯æ—¥é‡å»ºæµç¨‹

> å¯é€šè¿‡ `make all` ä¸€é”®æ‰§è¡Œ

```bash
make all
```

ç­‰ä»·äºæ‰‹åŠ¨æ‰§è¡Œï¼š

1. å¯åŠ¨åŸºç¡€è®¾æ–½ï¼ˆNAT + ALB + EKSï¼‰

```bash
make start
```

2. ä½¿ç”¨ `eksctl` åˆ›å»ºæ§åˆ¶é¢ï¼ˆä»…é¦–æ¬¡ï¼‰

```bash
make start-cluster
```

3. è‡ªåŠ¨ä¸º ASG ç»‘å®š Spot Interruption SNS é€šçŸ¥

```bash
make post-recreate
```

è¯¥è„šæœ¬å…·å¤‡ï¼š

* è‡ªåŠ¨è¯†åˆ«å½“å‰ ASG åç§°
* é˜²é‡å¤ç»‘å®šï¼ˆæœ¬åœ°è®°å½• `.last-asg-bound`ï¼‰
* æ—¥å¿—è¾“å‡ºåˆ° `scripts/logs/post-recreate.log`

---

## ğŸŒ™ æ—¥å¸¸å…³é—­èµ„æºä»¥èŠ‚çœæˆæœ¬

è‹¥ä½ åªéœ€æš‚æ—¶å…³é—­èµ„æºï¼š

```bash
make stop
```

> è¯¥æ“ä½œä¸ä¼šåˆ é™¤ VPCã€Route Tableã€KMS ç­‰åŸºç¡€ç»“æ„

---

## ğŸ’£ ä¸€é”®å½»åº•é”€æ¯æ‰€æœ‰èµ„æº

é€‚ç”¨äºå½»åº•é‡å»ºæˆ–ç¯å¢ƒè¿ç§»ï¼š

```bash
make destroy-all
```

> ä¼šåŒæ—¶è°ƒç”¨ `eksctl delete cluster` ä¸ `terraform destroy`

---

## ğŸ“œ æŸ¥çœ‹æ—¥å¿—ä¸æ¸…ç†çŠ¶æ€

### æŸ¥çœ‹æœ€è¿‘æ‰§è¡Œæ—¥å¿—ï¼š

```bash
make logs
```

### æ¸…ç†çŠ¶æ€ç¼“å­˜æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
make clean
```

---

## ğŸ” è„šæœ¬è‡ªåŠ¨åŒ–é€»è¾‘è¯´æ˜ï¼ˆpost-recreate.shï¼‰

æ ¸å¿ƒè·¯å¾„ï¼š`scripts/post-recreate.sh`

* è‡ªåŠ¨æŸ¥æ‰¾å½“å‰ ASG åç§°ï¼ˆä»¥ `eks-ng-mixed` ä¸ºå‰ç¼€ï¼‰
* è‹¥å°šæœªç»‘å®š SNS é€šçŸ¥ï¼Œåˆ™ç»‘å®šï¼š

  * `autoscaling:EC2_INSTANCE_TERMINATE`
  * SNS Topicï¼š`spot-interruption-topic`
* çŠ¶æ€è®°å½•ï¼š`scripts/.last-asg-bound`
* æ—¥å¿—ï¼š`scripts/logs/post-recreate.log`

---

## âœ… æ¨è gitignore é…ç½®

```gitignore
scripts/.last-asg-bound
scripts/logs/*
!scripts/logs/.gitkeep
```

---

## ğŸ“¦ åç»­è§„åˆ’ï¼ˆå¯é€‰ï¼‰

* å°† SNS Topic ä¸ Budget ä¹Ÿçº³å…¥ Terraform ç®¡ç†
* æ”¯æŒé€šçŸ¥ç»‘å®šè¦†ç›–å¤šä¸ª NodeGroup
* æ•´åˆ GitHub Actions è‡ªåŠ¨æ‰§è¡Œ `make all`
