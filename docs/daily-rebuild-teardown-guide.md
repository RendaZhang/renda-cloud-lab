<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
## ç›®å½• (Table of Contents)

-  [æ¯æ—¥ Terraform é‡å»ºä¸é”€æ¯æµç¨‹æ“ä½œæ–‡æ¡£](#%E6%AF%8F%E6%97%A5-terraform-%E9%87%8D%E5%BB%BA%E4%B8%8E%E9%94%80%E6%AF%81%E6%B5%81%E7%A8%8B%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3)
  -  [ğŸŒ… æ¯æ—¥é‡å»ºæµç¨‹ (Morning Rebuild Procedure)](#-%E6%AF%8F%E6%97%A5%E9%87%8D%E5%BB%BA%E6%B5%81%E7%A8%8B-morning-rebuild-procedure)
    -  [æ“ä½œç›®çš„ä¸èƒŒæ™¯ (Purpose & Background)](#%E6%93%8D%E4%BD%9C%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%83%8C%E6%99%AF-purpose--background)
    -  [æ­¥éª¤ä¸å‘½ä»¤è¯¦è§£ (Steps and Commands)](#%E6%AD%A5%E9%AA%A4%E4%B8%8E%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3-steps-and-commands)
    -  [å¸¸è§é”™è¯¯ä¸æ’æŸ¥æŒ‡å¼• (Common Errors & Troubleshooting)](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E4%B8%8E%E6%8E%92%E6%9F%A5%E6%8C%87%E5%BC%95-common-errors--troubleshooting)
  -  [âœ… éªŒæ”¶æ¸…å• (Morning Checklist)](#-%E9%AA%8C%E6%94%B6%E6%B8%85%E5%8D%95-morning-checklist)
  -  [ğŸŒ™ æ¯æ—¥é”€æ¯æµç¨‹ (Evening Teardown Procedure)](#-%E6%AF%8F%E6%97%A5%E9%94%80%E6%AF%81%E6%B5%81%E7%A8%8B-evening-teardown-procedure)
    -  [æ“ä½œç›®çš„ä¸èƒŒæ™¯ (Purpose & Background)](#%E6%93%8D%E4%BD%9C%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%83%8C%E6%99%AF-purpose--background-1)
    -  [æ­¥éª¤ä¸å‘½ä»¤è¯¦è§£ (Steps and Commands)](#%E6%AD%A5%E9%AA%A4%E4%B8%8E%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3-steps-and-commands-1)
    -  [å¸¸è§é”™è¯¯ä¸æ’æŸ¥æŒ‡å¼• (Common Errors & Troubleshooting)](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E4%B8%8E%E6%8E%92%E6%9F%A5%E6%8C%87%E5%BC%95-common-errors--troubleshooting-1)
  -  [âœ… é”€æ¯æ¸…å•éªŒè¯ (Evening Checklist)](#-%E9%94%80%E6%AF%81%E6%B8%85%E5%8D%95%E9%AA%8C%E8%AF%81-evening-checklist)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# æ¯æ—¥ Terraform é‡å»ºä¸é”€æ¯æµç¨‹æ“ä½œæ–‡æ¡£

* **Last Updated:** July 6, 2025, 23:20 (UTC+8)
* **ä½œè€…:** å¼ äººå¤§ï¼ˆRenda Zhangï¼‰

## ğŸŒ… æ¯æ—¥é‡å»ºæµç¨‹ (Morning Rebuild Procedure)

### æ“ä½œç›®çš„ä¸èƒŒæ™¯ (Purpose & Background)

 æ¯æ—¥æ—©æ™¨çš„é‡å»ºæµç¨‹æ—¨åœ¨æ¢å¤å‰ä¸€æ™šä¸ºèŠ‚çœæˆæœ¬è€Œé‡Šæ”¾çš„äº‘èµ„æºï¼Œä»¥ä¾¿ç™½å¤©å¼€å±•å®éªŒæˆ–å¼€å‘å·¥ä½œã€‚é€šè¿‡åœ¨æ—©æ™¨è‡ªåŠ¨éƒ¨ç½²å¿…è¦çš„åŸºç¡€è®¾æ–½ï¼ˆå¦‚ NAT ç½‘å…³ã€ALB è´Ÿè½½å‡è¡¡ï¼‰å¹¶ç¡®ä¿ EKS é›†ç¾¤æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¡®ä¿åŠŸèƒ½å®Œæ•´çš„åŒæ—¶ï¼Œå°†ä¸å¿…è¦çš„äº‘å¼€é”€é™è‡³æœ€ä½ã€‚è¿™ä¸€ç­–ç•¥åˆ©ç”¨ Terraform å’Œè„šæœ¬å®ç°äº‘èµ„æºçš„ **â€œæ—¥é—´å¯ç”¨ï¼Œå¤œé—´é”€æ¯â€**â€”â€”æ¯å¤©ä¸Šåˆé‡å»ºç¯å¢ƒã€æ™šä¸Šé”€æ¯é«˜æˆæœ¬èµ„æºï¼Œä»è€Œä¿ç•™åŸºç¡€è®¾æ–½çŠ¶æ€ä»¥ä¾¿å¿«é€Ÿé‡å»ºï¼Œå¹¶é¿å…ä¸å¿…è¦çš„æ”¯å‡ºã€‚
æ­¤å¤–ï¼Œæœ¬ä»“åº“å·²é€šè¿‡ Terraform åˆ›å»º AWS Budgetsï¼ˆé»˜è®¤ 90 USDï¼‰ï¼Œå½“èŠ±è´¹æ¥è¿‘é˜ˆå€¼æ—¶ä¼šä»¥é‚®ä»¶æé†’ã€‚(AWS Budgets are provisioned via Terraform with a default 90 USD limit to email alerts when spending nears the threshold.)


### æ­¥éª¤ä¸å‘½ä»¤è¯¦è§£ (Steps and Commands)

1. **AWS SSO ç™»å½• (AWS SSO Login)**ï¼šåœ¨è¿›è¡Œä»»ä½• AWS èµ„æºæ“ä½œä¹‹å‰ï¼Œéœ€ä½¿ç”¨ AWS Single Sign-On ç™»å½•è·å–ä¸´æ—¶å‡­è¯ã€‚æ¨èç›´æ¥æ‰§è¡Œ `make aws-login`ï¼Œå®ƒä¼šè°ƒç”¨ `aws sso login --profile phase2-sso` å¹¶è¾“å‡ºç™»å½•çŠ¶æ€ã€‚

   ```bash
   make aws-login
   ```

   *é¢„æœŸè¾“å‡º*: ç™»å½•æˆåŠŸåç»ˆç«¯æ— æ˜æ˜¾è¾“å‡ºã€‚å¦‚æœå‡­è¯æœ‰æ•ˆæœŸå·²è¿‡ï¼Œåˆ™ä¸Šè¿°å‘½ä»¤ä¼šæç¤ºæ‰“å¼€æµè§ˆå™¨è¿›è¡Œé‡æ–°è®¤è¯ã€‚å®Œæˆç™»å½•åï¼Œå¯ç»§ç»­åç»­æ­¥éª¤ã€‚

2. **(ä»…é¦–æ¬¡) åˆ›å»º Spot Interruption SNS Topic** (First-Time Topic Setup)ï¼šè‹¥è¿˜æœªåˆ›å»º `spot-interruption-topic`ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°æ‰‹åŠ¨æ“ä½œï¼Œæˆ–æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¹¶è®¢é˜…é‚®ç®±ï¼š

   ```bash
   aws sns create-topic --name spot-interruption-topic \
     --profile phase2-sso --region us-east-1 \
     --output text --query 'TopicArn'
   export SPOT_TOPIC_ARN=arn:aws:sns:us-east-1:123456789012:spot-interruption-topic
   aws sns subscribe --topic-arn $SPOT_TOPIC_ARN \
     --protocol email --notification-endpoint you@example.com \
     --profile phase2-sso --region us-east-1
   ```

   æ‰“å¼€é‚®ç®±ç‚¹å‡» **Confirm** å®Œæˆè®¢é˜…ã€‚è¯¥ Topic åªéœ€åˆ›å»ºä¸€æ¬¡ï¼Œåç»­æ‰§è¡Œ `make post-recreate` ä¼šè‡ªåŠ¨ç»‘å®šæœ€æ–° ASGã€‚
   (Open your mailbox and click **Confirm** to finalize the subscription. The topic only needs to be created once; later runs of `make post-recreate` will subscribe the latest ASG automatically.)

3. **å¯åŠ¨åŸºç¡€è®¾æ–½ (Start Infrastructure)**ï¼šé¦–å…ˆå¯åŠ¨åŸºç¡€ç½‘ç»œå’Œå¿…è¦ç»„ä»¶ï¼ŒåŒ…æ‹¬ NAT ç½‘å…³å’Œ ALBã€‚æ­¤æ­¥éª¤ä¼šåˆ›å»º VPC ä¸‹çš„ç½‘ç»œå‡ºå£ (NAT Gatewayï¼Œéœ€è¦ Elastic IP) å’Œé›†ç¾¤å…¥å£ (Application Load Balancer) ç­‰èµ„æºï¼Œä¸º EKS é›†ç¾¤æä¾›æ‰€éœ€çš„ç½‘ç»œç¯å¢ƒã€‚

   * **Makefile å‘½ä»¤**ï¼šæ‰§è¡Œ `make start` ä¸€é”®åº”ç”¨ Terraform æ¨¡æ¿æ¥åˆ›å»º NAT ç½‘å…³å’Œ ALBã€‚è¯¥å‘½ä»¤å†…éƒ¨ä¼šåœ¨ `infra/aws` ç›®å½•ä¸‹è°ƒç”¨ `terraform apply`ï¼Œå°†å˜é‡ `create_nat`ã€`create_alb` è®¾ç½®ä¸º trueï¼ˆ`create_eks` äº¦é»˜è®¤ä¸º trueï¼‰ã€‚è¿™æ ·å°†å¯ç”¨ NAT å’Œ ALB ç›¸å…³èµ„æºï¼Œå¹¶ç¡®ä¿ EKS é›†ç¾¤èµ„æºåŒ…å«åœ¨éƒ¨ç½²ä¸­ã€‚å¦‚æœå‰ä¸€æ™šæ‰§è¡Œäº†é›†ç¾¤é”€æ¯ï¼Œåˆ™æ­¤æ­¥éª¤ä¼šé€šè¿‡ Terraform **æ–°å»º** EKS æ§åˆ¶é¢å’ŒèŠ‚ç‚¹ç»„ï¼›è‹¥é›†ç¾¤å°šå­˜åœ¨äº Terraform çŠ¶æ€ä¸­ï¼ŒTerraform å°†è¯†åˆ«å·²æœ‰é›†ç¾¤ä¸”ä¸é‡å¤åˆ›å»ºï¼Œä»…éªŒè¯é…ç½®ä¸€è‡´æ€§ã€‚

   * **æ‰‹åŠ¨ Terraform å‘½ä»¤**ï¼šç­‰ä»·æ“ä½œæ˜¯æ‰‹åŠ¨è¿è¡Œ Terraform éƒ¨ç½²ã€‚åœ¨ç»ˆç«¯ä¸­åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•çš„ `infra/aws` è·¯å¾„ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

     ```bash
     terraform apply -auto-approve \
       -var="region=us-east-1" \
       -var="create_nat=true" \
       -var="create_alb=true" \
       -var="create_eks=true"
     ```

     ä¸Šè¿°å‘½ä»¤ä¼šæ ¹æ® Terraform é…ç½®åœ¨åŒºåŸŸ `us-east-1` ä¸­åˆ›å»ºå¯ç”¨ NAT å’Œ ALB çš„åŸºç¡€è®¾æ–½ï¼Œä»¥åŠåŒ…å« EKS é›†ç¾¤çš„ç›¸å…³èµ„æºéƒ¨ç½²ã€‚å…¶ä¸­ `-auto-approve` ç”¨äºè‡ªåŠ¨ç¡®è®¤ï¼Œæ— éœ€äººå·¥äº¤äº’ã€‚å˜é‡ `create_nat=true` å’Œ `create_alb=true` å¯ç”¨ NAT ç½‘å…³ä¸ ALB èµ„æºçš„åˆ›å»ºã€‚`create_eks=true` åˆ™åŒ…å« EKS é›†ç¾¤åŠèŠ‚ç‚¹ç»„èµ„æºçš„åˆ›å»ºæˆ–ä¿æŒã€‚Terraform å°†ä½¿ç”¨ **è¿œç«¯çŠ¶æ€åç«¯**ï¼ˆS3 Bucket: `phase2-tf-state-us-east-1`ï¼ŒDynamoDB é”è¡¨: `tf-state-lock`ï¼‰è®°å½•æ­¤æ¬¡éƒ¨ç½²çš„çŠ¶æ€ã€‚

     *é¢„æœŸè¾“å‡º*: Terraform æ‰§è¡ŒæˆåŠŸåï¼Œå°†æ˜¾ç¤ºå„èµ„æºåˆ›å»ºæ˜ç»†å’Œæ€»ç»“ã€‚


4. **éªŒè¯ Terraform çŠ¶æ€ä¸€è‡´ (Verify Terraform State Consistency)**ï¼šTerraform æ‰§è¡Œå®Œæˆåï¼Œå»ºè®®å†æ¬¡è¿è¡Œ `terraform plan`ï¼Œç¡®ä¿çŠ¶æ€ä¸å®é™…èµ„æºæ— åå·®ã€‚Plan è¿”å› *No changes* å³è¡¨ç¤ºèµ„æºå®Œå…¨åŒæ­¥ï¼Œå¯æ”¾å¿ƒè¿›å…¥ä¸‹ä¸€æ­¥ã€‚

   > æç¤ºï¼šåœ¨ä»Šåçš„æ—¥å¸¸æµç¨‹ä¸­ï¼Œè‹¥æ€€ç–‘ Terraform çŠ¶æ€ä¸å®é™…èµ„æºä¸åŒæ­¥ï¼Œå¯éšæ—¶è¿è¡Œ `terraform plan` è¿›è¡Œæ£€æŸ¥ã€‚ä¸€æ—¦å‘ç° driftï¼Œåº”ç«‹å³æ’æŸ¥åŸå› æˆ–é€šè¿‡ `terraform import` ç­‰æ‰‹æ®µä¿®æ­£ï¼Œä»¥ç¡®ä¿ Terraform ç®¡ç†çš„èµ„æºä¸çœŸå®ç¯å¢ƒåŒ¹é…ã€‚

5. **è¿è¡Œ Post Recreate è„šæœ¬**ï¼šè¯¥è„šæœ¬è‡ªåŠ¨è®°å½•æ—¥å¿—ã€ç®€åŒ– AWS ASG é…ç½®ï¼Œå¹¶é€šè¿‡ Helm ç¡®ä¿ Cluster Autoscaler ä¸é›†ç¾¤ç‰ˆæœ¬ä¸€è‡´ã€‚æ­¤å¤–ï¼Œå®ƒä¼šæ£€æŸ¥ NAT ç½‘å…³ã€ALBã€EKS æ§åˆ¶å¹³é¢ã€èŠ‚ç‚¹ç»„ã€æ—¥å¿—ç»„ç­‰èµ„æºæ˜¯å¦æ­£å¸¸ï¼Œå¹¶éªŒè¯ SNS å‘Šè­¦è®¢é˜…æ˜¯å¦ç”Ÿæ•ˆã€‚

   * **Makefile å‘½ä»¤**ï¼šæ‰§è¡Œ `make post-recreate` è°ƒç”¨è„šæœ¬ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºæ—¥å¿—å¹¶ä¿å­˜åˆ° scripts/logs/post-recreate.log æ–‡ä»¶ä¸­ã€‚å®ƒç®€åŒ–äº† AWS è‡ªåŠ¨æ‰©ç¼©ç»„ï¼ˆASGï¼‰çš„é€šçŸ¥é…ç½®ï¼Œé¿å…äº†æ‰‹åŠ¨ä½¿ç”¨ AWS CLI çš„å¤æ‚æ“ä½œã€‚æ­¤å¤–ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨é€šè¿‡ Helm å®‰è£… / å‡çº§ Cluster Autoscalerï¼Œç¡®ä¿èŠ‚ç‚¹è‡ªåŠ¨æ‰©ç¼©å®¹ç»„ä»¶ä¸é›†ç¾¤ç‰ˆæœ¬ä¸€è‡´ã€‚è¯¥è„šæœ¬å…·æœ‰å¹‚ç­‰æ€§ï¼Œå¯ä»¥å¤šæ¬¡æ‰§è¡Œã€‚

   * **æ‰‹åŠ¨ CLI å‘½ä»¤**ï¼šäº¦å¯æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬æˆ–ä½¿ç”¨ AWS CLI å®Œæˆç›¸åŒæ“ä½œã€‚æ¨èç›´æ¥è¿è¡Œä»“åº“æä¾›çš„è„šæœ¬ï¼š

     ```bash
     bash scripts/post-recreate.sh
     ```

è¯¥è„šæœ¬æ‰§è¡Œåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºç»‘å®šå’Œèµ„æºæ£€æŸ¥çš„æ—¥å¿—ï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ° `scripts/logs/post-recreate.log` æ–‡ä»¶ã€‚æ‰‹åŠ¨æ–¹å¼äº¦å¯ä½¿ç”¨ AWS CLI å®Œæˆï¼Œä½†éœ€æ‰‹åŠ¨æŸ¥è¯¢æœ€æ–° ASG åç§°å¹¶éªŒè¯å„ç§èµ„æºçŠ¶æ€ã€‚è„šæœ¬åœ¨æ›´æ–° kubeconfig åä¼šè‡ªåŠ¨é€šè¿‡ Helm å®‰è£…/å‡çº§ Cluster Autoscalerï¼Œå¹¶æ£€æŸ¥ NAT ç½‘å…³ã€ALBã€EKS ä¸èŠ‚ç‚¹ç»„çŠ¶æ€ä»¥åŠæ—¥å¿—ç»„ä¸ SNS é€šçŸ¥é…ç½®ï¼Œç¡®ä¿ç¯å¢ƒå®Œå…¨å°±ç»ªã€‚

6. **éªŒè¯æ§åˆ¶é¢æ—¥å¿—ä¸ Spot é€šçŸ¥ (Verify Control Plane Logs & Spot Notifications)**ï¼š

   * **æ§åˆ¶é¢æ—¥å¿— (Control Plane Logs)**ï¼šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç¡®è®¤ `api` ä¸ `authenticator` æ—¥å¿—å·²å¯ç”¨ï¼Œä¸” CloudWatch æ—¥å¿—ç»„ `/aws/eks/dev/cluster` å·²åˆ›å»ºï¼š

     ```bash
     aws eks describe-cluster --name dev --profile phase2-sso --region us-east-1 --query "cluster.logging.clusterLogging[?enabled].types" --output table
     aws logs describe-log-groups --profile phase2-sso --region us-east-1 --log-group-name-prefix "/aws/eks/dev/cluster" --query 'logGroups[].logGroupName' --output text
     ```

     é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š

     ```plaintext
     --------------------------
     |     DescribeCluster    |
     +------+-----------------+
     |  api |  authenticator  |
     +------+-----------------+
     /aws/eks/dev/cluster
     ```

     éšåå¯åœ¨ **AWS Console âœ CloudWatch âœ Logs âœ Log groups** ä¸­çœ‹åˆ° `api`ã€`authenticator` ç­‰æ—¥å¿—æµã€‚

   * **Spot é€šçŸ¥è®¢é˜… (Spot Notification Subscription)**ï¼šç™»å½• **AWS Console âœ SNS âœ Topics âœ `spot-interruption-topic` âœ Subscriptions**ï¼Œåº”çœ‹åˆ°çŠ¶æ€ä¸º `Confirmed`ï¼Œå¹¶åœ¨ç»‘å®šæˆåŠŸåæ”¶åˆ°é‚®ä»¶é€šçŸ¥ã€‚

ğŸ’¡ **æ”¹è¿›è¯´æ˜**ï¼šç°é˜¶æ®µé›†ç¾¤å®Œå…¨ç”± Terraform ç®¡ç†ï¼ŒMakefile å·²ç»Ÿä¸€é›†æˆæ‰€æœ‰æ“ä½œã€‚é¦–æ¬¡å¯¼å…¥åå³å¯åå¤é‡å»ºï¼Œæ— éœ€å†è¿è¡Œ eksctlï¼Œä¹Ÿé¿å…äº†å¤šå·¥å…·å¹¶è¡Œå¸¦æ¥çš„çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜ã€‚åç»­å¯åœ¨ `make start` ç­‰å‘½ä»¤ä¸­åŠ å…¥é›†ç¾¤å­˜åœ¨æ€§æ£€æŸ¥ï¼Œè¿›ä¸€æ­¥æå‡æµç¨‹å¥å£®æ€§ã€‚

### å¸¸è§é”™è¯¯ä¸æ’æŸ¥æŒ‡å¼• (Common Errors & Troubleshooting)

* **Terraform çŠ¶æ€é”å®š (State lock)**ï¼šå¦‚æœåœ¨æ‰§è¡Œ Terraform å‘½ä»¤æ—¶é‡åˆ°ç±»ä¼¼ *â€œError: Error acquiring the state lockâ€* çš„é”™è¯¯ï¼Œè¯´æ˜å…ˆå‰çš„ Terraform è¿›ç¨‹æœªæ­£å¸¸è§£é”çŠ¶æ€æ–‡ä»¶ã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œå¯ç™»å½• AWS æ§åˆ¶å°åˆ é™¤ DynamoDB é”å®šè¡¨ (`tf-state-lock`) ä¸­ç›¸åº”çš„é”æ¡ç›®ï¼Œæˆ–ä½¿ç”¨å‘½ä»¤è¡Œå¼ºåˆ¶è§£é”ï¼š

  ```bash
  terraform force-unlock <é”ID> -force
  ```

  *æ’æŸ¥æç¤º*: é” ID ä¼šåœ¨é”™è¯¯ä¿¡æ¯ä¸­æä¾›ã€‚**åŠ¡å¿…ç¡®è®¤æ²¡æœ‰å…¶ä»– Terraform è¿›ç¨‹åœ¨è¿è¡Œ**åå†æ‰§è¡Œå¼ºåˆ¶è§£é”ï¼Œé¿å…å¹¶å‘ä¿®æ”¹çŠ¶æ€ã€‚

* **AWS å‡­è¯è¿‡æœŸ (SSO Token Expired)**ï¼šå¦‚æœå‘½ä»¤è¡Œå‡ºç° `ExpiredToken`ã€`InvalidClientTokenId` ç­‰é”™è¯¯ï¼Œé€šå¸¸æ˜¯ AWS SSO å‡­è¯å·²è¿‡æœŸæˆ–æœªç™»å½•æ‰€è‡´ã€‚è§£å†³åŠæ³•æ˜¯åœ¨å½“å‰ç»ˆç«¯é‡æ–°æ‰§è¡Œ `aws sso login --profile phase2-sso` ç™»å½•ï¼Œç„¶åé‡è¯•ç›¸å…³ Terraform æˆ– AWS CLI æ“ä½œã€‚ä¸ºäº†é˜²æ­¢é•¿æ—¶é—´æ“ä½œæœŸé—´å‡­è¯å¤±æ•ˆï¼Œå»ºè®®åœ¨é‡è¦æ­¥éª¤å‰ç¡®è®¤å‡­è¯æœ‰æ•ˆï¼ˆå¯é€šè¿‡ `aws sts get-caller-identity --profile phase2-sso` éªŒè¯ï¼‰ã€‚

* **Elastic IP é…é¢ä¸è¶³ (EIP Quota)**ï¼šNAT ç½‘å…³åˆ›å»ºéœ€è¦åˆ†é…å…¬æœ‰ IP (EIP)ã€‚AWS é»˜è®¤æ¯åŒºæœ€å¤šæä¾› 5 ä¸ª Elastic IPã€‚å¦‚æœç¯å¢ƒä¸­å·²æœ‰å¤šä¸ª EIP å ç”¨ï¼ŒTerraform åœ¨åˆ›å»º NAT ç½‘å…³æ—¶å¯èƒ½æŠ¥é”™ `Error: Error creating NAT Gateway: InsufficientAddressCapacity` æˆ–ç›¸å…³é…é¢é”™è¯¯ã€‚æ­¤æ—¶åº”æ£€æŸ¥è´¦æˆ·çš„ EIP ä½¿ç”¨æƒ…å†µï¼šæ‰§è¡Œ `aws ec2 describe-addresses --region us-east-1 --profile phase2-sso` æŸ¥çœ‹å·²åˆ†é…çš„ EIP æ•°é‡ã€‚å¦‚å·²è¾¾åˆ°ä¸Šé™ï¼Œå¯é‡Šæ”¾ä¸éœ€è¦çš„ EIPï¼Œæˆ–é€šè¿‡æäº¤ AWS Support å·¥å•ç”³è¯·æé«˜é…é¢ã€‚

* **é›†ç¾¤åˆ›å»ºå¤±è´¥æˆ–è¶…æ—¶ (EKS Cluster Creation Failure)**ï¼šå¦‚æœ Terraform åˆ›å»º EKS é›†ç¾¤çš„æ­¥éª¤å¤±è´¥ï¼ˆä¾‹å¦‚ç½‘ç»œä¸é€šæˆ–æƒé™é—®é¢˜å¯¼è‡´æ§åˆ¶é¢åˆ›å»ºå¤±è´¥ï¼‰ï¼Œè¯·é¦–å…ˆæ£€æŸ¥ Terraform éƒ¨ç½²çš„åŸºç¡€è®¾æ–½æ˜¯å¦å…¨éƒ¨åˆ›å»ºæˆåŠŸï¼ˆVPCã€å­ç½‘ã€è·¯ç”±ç­‰æ˜¯å¦å°±ç»ªï¼‰ã€‚å¸¸è§åŸå› åŒ…æ‹¬ï¼šæœªæ­£ç¡®é…ç½® EKS Roleï¼Œå¯èƒ½å¯¼è‡´ EKS æ§åˆ¶é¢åˆ›å»ºæƒé™ä¸è¶³ï¼›æˆ–è€…ä¹‹å‰å·²æœ‰åŒåé›†ç¾¤æœªåˆ é™¤å¹²å‡€å¯¼è‡´åç§°å†²çªã€‚å¯¹äºæƒé™é—®é¢˜ï¼Œå¯ç¡®è®¤ Terraform é…ç½®ä¸­çš„ IAM Role æ˜¯å¦æ­£ç¡®ã€‚å¦‚æ˜¯åç§°å†²çªï¼Œéœ€ç¡®ä¿å°†ç°æœ‰çš„åŒåé›†ç¾¤åˆ é™¤æˆ–å¯¼å…¥ Terraform ç®¡ç†ï¼šå¯ä»¥é€šè¿‡ AWS CLI æˆ–æ§åˆ¶å°åˆ é™¤æ®‹ç•™çš„é›†ç¾¤ï¼Œç„¶åé‡æ–°æ‰§è¡Œéƒ¨ç½²ã€‚è‹¥åˆ›å»ºè¿‡ç¨‹é•¿æ—¶é—´æ— å“åº”ï¼Œå¯ç™»å½• AWS æ§åˆ¶å°æŸ¥çœ‹ EKS é›†ç¾¤çŠ¶æ€æˆ– CloudFormation æœåŠ¡ï¼Œæ‰¾åˆ°å¤±è´¥åŸå› å¹¶é’ˆå¯¹æ€§å¤„ç†ã€‚

* **Terraform è®¡åˆ’æœ‰æ„å¤–æ›´æ”¹ (Unexpected Terraform Plan Changes)**ï¼šå¦‚æœåœ¨æ—¥å¸¸è¿è¡Œ `terraform plan` æˆ– `make start/stop` æ—¶çœ‹åˆ°æœ‰éé¢„æœŸçš„èµ„æºæ›´æ”¹ï¼ˆå¦‚è®¡åˆ’é”€æ¯æˆ–æ–°å»ºé›†ç¾¤ç­‰ï¼‰ï¼Œåº”æ£€æŸ¥æ˜¯å¦æœ‰äººå·¥åœ¨ AWS æ§åˆ¶å°æˆ–å…¶ä»–å·¥å…·ä¸­ä¿®æ”¹äº†åŸºç¡€è®¾æ–½ï¼ˆä¾‹å¦‚ä¿®æ”¹äº†å®‰å…¨ç»„è§„åˆ™ã€åˆ é™¤äº†æŸäº›èµ„æºç­‰ï¼‰ã€‚æ­¤æ—¶å»ºè®®è°¨æ…æ‰§è¡Œ Terraformï¼Œå…ˆå¼„æ¸…å˜æ›´æ¥æºã€‚å¦‚ç¡®å®å­˜åœ¨ driftï¼Œå¯é€šè¿‡ Terraform Import æˆ–æ‰‹åŠ¨è°ƒæ•´ Terraform é…ç½®æ¥æ¶ˆé™¤ä¸ä¸€è‡´ï¼Œç„¶åå†æ¬¡è¿è¡Œ plan éªŒè¯æ— å˜åŠ¨åå†è¿›è¡Œ applyã€‚

## âœ… éªŒæ”¶æ¸…å• (Morning Checklist)

æ—©æ™¨é‡å»ºæµç¨‹å®Œæˆåï¼Œå¯æ ¹æ®ä»¥ä¸‹æ¸…å•é€é¡¹æ ¸å®ç¯å¢ƒå·²æ­£ç¡®é‡å»ºï¼š

* âœ… **NAT ç½‘å…³**ï¼šå·²åˆ›å»ºå¹¶åˆ†é… Elastic IPï¼ŒçŠ¶æ€ä¸º *Available*ï¼ˆå¯é€šè¿‡ AWS æ§åˆ¶å° VPC é¡µé¢æˆ– CLI å‘½ä»¤ç¡®è®¤ï¼‰ã€‚
* âœ… **ALB è´Ÿè½½å‡è¡¡**ï¼šå·²åˆ›å»ºå¹¶å¤„äº *active* çŠ¶æ€ï¼Œç›‘å¬ç›¸åº”ç«¯å£ã€‚è‹¥é…ç½®äº†è‡ªå®šä¹‰åŸŸå (`lab.rendazhang.com`)ï¼Œå¯éªŒè¯è¯¥åŸŸåå·²è§£æåˆ°æ–°çš„ ALB DNS åœ°å€ã€‚
* âœ… **EKS æ§åˆ¶å¹³é¢**ï¼šé›†ç¾¤çŠ¶æ€ä¸º *ACTIVE*ã€‚å¯ä»¥é€šè¿‡ `aws eks describe-cluster --name dev --region us-east-1 --profile phase2-sso` æ£€æŸ¥é›†ç¾¤å­˜åœ¨ä¸”çŠ¶æ€æ­£å¸¸ã€‚kubectl é…ç½®å·²æ›´æ–°ï¼Œæ‰§è¡Œ `kubectl get nodes` å¯ä»¥çœ‹åˆ°èŠ‚ç‚¹çŠ¶æ€ä¸º Readyï¼ˆå¦‚æœæœ‰èŠ‚ç‚¹è¿è¡Œï¼‰ã€‚
* âœ… **èŠ‚ç‚¹ç»„åŠè‡ªåŠ¨ä¼¸ç¼©**ï¼šé»˜è®¤èŠ‚ç‚¹ç»„æ­£å¸¸è¿è¡Œã€‚å¦‚å½“å‰æ— å·¥ä½œè´Ÿè½½ä¸”å¯ç”¨äº†è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ŒèŠ‚ç‚¹æ•°å¯èƒ½å·²è‡ªåŠ¨ç¼©å‡è‡³ 0ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œ`kubectl get nodes` å¯èƒ½æš‚æ—¶æ— èŠ‚ç‚¹åˆ—è¡¨ï¼Œè¿™æ˜¯é¢„æœŸè¡Œä¸ºâ€”â€”åç»­æœ‰æ–°å·¥ä½œè´Ÿè½½è°ƒåº¦æ—¶ï¼ŒèŠ‚ç‚¹ä¼šè‡ªåŠ¨å¯åŠ¨ã€‚
* âœ… **Cluster Autoscaler**ï¼šè¿è¡Œ `kubectl --namespace=kube-system get pods -l "app.kubernetes.io/name=aws-cluster-autoscaler,app.kubernetes.io/instance=cluster-autoscaler"`ï¼ŒPod åº”å¤„äº `Running` ä¸”å…¶ ServiceAccount æ³¨è§£å«æœ‰ `role-arn`
* âœ… **æ§åˆ¶é¢æ—¥å¿—ä¸ LogGroup**ï¼šæ‰§è¡Œ `aws eks describe-cluster` ä¸ `aws logs describe-log-groups`ï¼Œåº”çœ‹åˆ° `api`ã€`authenticator` æ—¥å¿—å·²å¯ç”¨ï¼Œä¸”å­˜åœ¨ `/aws/eks/dev/cluster` æ—¥å¿—ç»„ã€‚
* âœ… **SNS é€šçŸ¥**ï¼šç¡®è®¤ Spot é€šçŸ¥è®¢é˜…æˆåŠŸã€‚å¯ç™»å½• AWS æ§åˆ¶å°æŸ¥çœ‹ SNS ä¸»é¢˜ *spot-interruption-topic* çš„è®¢é˜…åˆ—è¡¨ï¼Œåº”åŒ…å«æœ€æ–°çš„ Auto Scaling Groupï¼ˆåç§°ä»¥ *eks-ng-mixed* å¼€å¤´ï¼‰ã€‚æˆ–è€…æ£€æŸ¥è„šæœ¬æ—¥å¿— `scripts/logs/post-recreate.log`ï¼Œæœ€åä¸€è¡Œåº”æ˜¾ç¤ºâ€œå·²ç»‘å®šæœ€æ–° ASGâ€ä¸”åç§°åŒ¹é…å½“å‰é›†ç¾¤èŠ‚ç‚¹ç»„ã€‚

---

## ğŸŒ™ æ¯æ—¥é”€æ¯æµç¨‹ (Evening Teardown Procedure)

### æ“ä½œç›®çš„ä¸èƒŒæ™¯ (Purpose & Background)

æ¯æ—¥å·¥ä½œç»“æŸé˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦é”€æ¯å½“æ—¥åˆ›å»ºçš„é«˜æˆæœ¬äº‘èµ„æºï¼Œä»¥é¿å…åœ¨é—²ç½®çš„å¤œé—´ç»§ç»­äº§ç”Ÿè´¹ç”¨ã€‚é€šè¿‡å¤œé—´**å…³åœä¸»è¦èµ„æº**çš„æµç¨‹ï¼Œæˆ‘ä»¬é‡Šæ”¾å¦‚ NAT ç½‘å…³ã€ALB ç­‰æŒ‰æ—¶è®¡è´¹çš„ç»„ä»¶ï¼ŒåŒæ—¶ä¿ç•™åŸºç¡€è®¾æ–½çš„ç½‘ç»œå’ŒçŠ¶æ€ï¼ˆä¾‹å¦‚ VPCã€å­ç½‘ä»¥åŠ Terraform Stateï¼‰ï¼Œä»¥åŠ é€Ÿæ¬¡æ—¥çš„ç¯å¢ƒé‡å»ºã€‚è¿™ç§ **â€œä¸‹ç­å…³åœï¼Œä¸Šç­é‡å¯â€** æ¨¡å¼ç¡®ä¿äº†å®éªŒç¯å¢ƒåœ¨éå·¥ä½œæ—¶æ®µçš„äº‘æˆæœ¬é™è‡³æœ€ä½ï¼ˆä»…å¯èƒ½ä¿ç•™å°‘é‡æ§åˆ¶é¢å›ºå®šæˆæœ¬ï¼‰ï¼ŒåŒæ—¶ä¿ç•™å¿…è¦çš„ç½‘ç»œé…ç½®ç”¨äºä¸‹æ¬¡å¯åŠ¨ã€‚

### æ­¥éª¤ä¸å‘½ä»¤è¯¦è§£ (Steps and Commands)

1. **AWS SSO ç™»å½• (AWS SSO Login)**ï¼šåœ¨é”€æ¯èµ„æºä¹‹å‰ï¼Œå…ˆç¡®ä¿ AWS ç™»å½•æœ‰æ•ˆï¼ˆåŒæ ·ä½¿ç”¨ `phase2-sso` Profileï¼‰ã€‚å¦‚æœè‡ªæ—©æ™¨ç™»å½•åå·²è¿‡äº†æ•°å°æ—¶ï¼Œå‡­è¯å¯èƒ½è¿‡æœŸï¼Œå»ºè®®é‡æ–°æ‰§è¡Œç™»å½•å‘½ä»¤ã€‚ç›´æ¥è¿è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼š

   ```bash
   make aws-login
   ```

   ç™»å½•æ–¹æ³•åŒä¸Šï¼Œä¸å†èµ˜è¿°ã€‚ç¡®è®¤å‡­è¯æœ‰æ•ˆåç»§ç»­åç»­æ“ä½œã€‚

2. **åœæ­¢é«˜æˆæœ¬èµ„æº (Shut Down High-Cost Resources)**ï¼šè¯¥æ­¥éª¤é€šè¿‡ Terraform é”€æ¯ç™½å¤©åˆ›å»ºçš„ NAT ç½‘å…³ã€ALB ç­‰èµ„æºï¼Œä½†ä¿ç•™åŸºç¡€ç½‘ç»œæ¡†æ¶ï¼Œæ–¹ä¾¿æ—¥åé‡å»ºã€‚EKS é›†ç¾¤çš„æ§åˆ¶é¢é€šå¸¸åœ¨æ­¤æ“ä½œä¸­äºˆä»¥ä¿ç•™è¿è¡Œï¼ˆé™¤éé€‰æ‹©äº†åŒæ—¶é”€æ¯é›†ç¾¤ï¼Œè¯¦è§åæ–‡â€œç¡¬åœæœºâ€è¯´æ˜æˆ–ä¸‹ä¸€æ­¥çš„å®Œå…¨é”€æ¯ï¼‰ã€‚

   * **Makefile å‘½ä»¤**ï¼šæ‰§è¡Œ `make stop` å³å¯ä¸€é”®é”€æ¯å½“æ—¥å¯ç”¨çš„å¤–å›´èµ„æºã€‚æ­¤å‘½ä»¤ä¼šåœ¨ `infra/aws` ç›®å½•ä¸‹è°ƒç”¨ Terraformï¼Œå°† `create_nat`ã€`create_alb` ç­‰å˜é‡ç½®ä¸º falseï¼ˆé»˜è®¤ä¸ä¿®æ”¹ `create_eks`ï¼Œé›†ç¾¤æ§åˆ¶é¢ä¿æŒå¼€å¯ï¼‰åæ‰§è¡Œ `terraform apply`ã€‚è‹¥å¸Œæœ›è¿åŒ EKS æ§åˆ¶é¢ä¸€èµ·å…³é—­ï¼Œå¯ä½¿ç”¨ `make stop-hard`ï¼Œè¯¥å‘½ä»¤ä¼šå°† `create_eks=false` ä¸€å¹¶é”€æ¯é›†ç¾¤ã€‚å¦‚éœ€é¢å¤–æ¸…ç† CloudWatch æ—¥å¿—ç»„å¹¶éªŒè¯èµ„æºæ˜¯å¦å®Œå…¨åˆ é™¤ï¼Œå¯ä½¿ç”¨ `make stop-all`ï¼Œå®ƒä¼šåœ¨ `stop-hard` åŸºç¡€ä¸Šè°ƒç”¨ `post-teardown.sh`ã€‚

   * **æ‰‹åŠ¨ Terraform å‘½ä»¤**ï¼šä¹Ÿå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ Terraform å®ç°ç›¸åŒæ•ˆæœã€‚åœ¨ `infra/aws` ç›®å½•ä¸‹è¿è¡Œå¦‚ä¸‹å‘½ä»¤å…³é—­ç›¸å…³ç»„ä»¶ï¼š

     **åˆ é™¤ NAT å’Œ ALB èµ„æºï¼Œä¿ç•™ EKS é›†ç¾¤è¿è¡Œï¼ˆå¸¸è§„åœæ­¢ï¼‰**ï¼š

     ```bash
     terraform apply -auto-approve \
       -var="region=us-east-1" \
       -var="create_nat=false" \
       -var="create_alb=false" \
       -var="create_eks=true"
     ```

     **åˆ é™¤ NAT, ALB & EKS é›†ç¾¤ï¼ˆç¡¬åœæœºï¼‰**ï¼š

     ```bash
     terraform apply -auto-approve \
       -var="region=us-east-1" \
       -var="create_nat=false" \
       -var="create_alb=false" \
       -var="create_eks=false"
     ```

     ä¸Šè¿°å‘½ä»¤é€šè¿‡å°† `create_nat` å’Œ `create_alb` è®¾ä¸º falseï¼Œä½¿ Terraform é”€æ¯ NAT å’Œ ALB ç›¸å…³èµ„æºã€‚åŒºåˆ«åœ¨äº `create_eks` çš„å–å€¼ï¼šä¿æŒ `create_eks=true` æ—¶ï¼ŒTerraform å°†ä¿ç•™å…¶çŠ¶æ€ä¸­ç®¡ç†çš„ EKS é›†ç¾¤åŠèŠ‚ç‚¹ç»„èµ„æºï¼Œä¸å¯¹å…¶åšæ”¹åŠ¨ï¼›è€Œå½“ `create_eks=false` æ—¶ï¼ŒTerraform ä¼šä¸€å¹¶é”€æ¯å—å…¶ç®¡ç†çš„ EKS é›†ç¾¤å’ŒèŠ‚ç‚¹ç»„ã€‚è¿™æ„å‘³ç€é€‰æ‹©â€œç¡¬åœæœºâ€ä¼šç§»é™¤ EKS æ§åˆ¶é¢å’Œæ‰€æœ‰èŠ‚ç‚¹ï¼ˆä»¥åŠå…³è”çš„å®‰å…¨ç»„ã€OIDC ç­‰ Terraform ç®¡ç†çš„é™„å±èµ„æºï¼‰ã€‚æ‰§è¡Œå‰è¯·ç¡®è®¤å·²ç™»å½• AWS ä¸”åç«¯çŠ¶æ€é…ç½®æ­£ç¡®ï¼Œä»¥å…é”€æ¯è¿‡ç¨‹å› æƒé™é—®é¢˜ä¸­æ–­ã€‚

     ä¸Šè¿°å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œé«˜æˆæœ¬çš„å…¬ç½‘å‡ºå£å’Œå…¥å£èµ„æºä¸å†è®¡è´¹ã€‚VPC ç­‰åŸºç¡€è®¾æ–½ä»¥åŠ EKS é›†ç¾¤ä»ä¿ç•™åœ¨ AWS è´¦æˆ·ä¸­ï¼ˆè¿™äº›ä¿ç•™çš„èµ„æºé€šå¸¸ä¸äº§ç”Ÿæ˜¾è‘—é¢å¤–è´¹ç”¨ï¼‰ã€‚

    æ‰§è¡Œç¡¬åœæœºå‘½ä»¤åï¼Œå¯é€šè¿‡ `aws eks list-clusters --region us-east-1 --profile phase2-sso` ç¡®è®¤é›†ç¾¤å·²ä¸å­˜åœ¨ã€‚
    **æ³¨æ„**ï¼šè‹¥å†å²ä¸Šæ›¾ä½¿ç”¨ eksctl åˆ›å»ºè¿‡é›†ç¾¤ï¼Œå¯èƒ½åœ¨ CloudFormation ä¸­ç•™ä¸‹ `eksctl-dev-cluster` ç­‰æ ˆã€‚Terraform åˆ é™¤é›†ç¾¤åï¼Œè¯·æ‰‹åŠ¨åˆ é™¤è¿™äº›æ ˆï¼Œä»¥é˜²èµ„æºæ®‹ç•™ã€‚
   * **Makefile å‘½ä»¤**ï¼šæ‰§è¡Œ `make destroy-all` è§¦å‘ä¸€é”®å®Œå…¨é”€æ¯æµç¨‹ã€‚è¯¥å‘½ä»¤ä¼šå…ˆè°ƒç”¨ `make stop-hard` åˆ é™¤ EKS æ§åˆ¶é¢ï¼Œå†è¿è¡Œ `terraform destroy` ä¸€æ¬¡æ€§åˆ é™¤åŒ…æ‹¬ NAT ç½‘å…³ã€ALBã€VPCã€å­ç½‘ã€å®‰å…¨ç»„ã€IAM è§’è‰²ç­‰åœ¨å†…çš„æ‰€æœ‰èµ„æºã€‚æœ€åä¼šè‡ªåŠ¨æ‰§è¡Œ `post-teardown.sh` æ¸…ç† CloudWatch æ—¥å¿—ç»„å¹¶å†æ¬¡éªŒè¯æ‰€æœ‰èµ„æºå‡å·²åˆ é™¤ã€‚`make destroy-all` ä¼šç¡®ä¿é¦–å…ˆå…³é—­ä»»ä½•ä»åœ¨è¿è¡Œçš„ç»„ä»¶ï¼Œç„¶åæ¸…ç† Terraform çŠ¶æ€ä¸­è®°å½•çš„æ‰€æœ‰èµ„æºã€‚æ‰§è¡Œå‰è¯·å†æ¬¡ç¡®è®¤ AWS å‡­è¯æœ‰æ•ˆä¸”æ— é‡è¦èµ„æºé—æ¼åœ¨çŠ¶æ€å¤–ã€‚

   * **æ‰‹åŠ¨é”€æ¯å‘½ä»¤**ï¼šå®Œæ•´é”€æ¯ä¹Ÿå¯é€šè¿‡ä¸€æ¡ Terraform æŒ‡ä»¤å®Œæˆã€‚åœ¨ `infra/aws` ç›®å½•ä¸‹æ‰§è¡Œï¼š

     ```bash
     terraform destroy -auto-approve -var="region=us-east-1"
     ```

     è¯¥å‘½ä»¤å°†åŸºäº Terraform çŠ¶æ€æ¸…å•åˆ é™¤æ‰€æœ‰ AWS èµ„æºï¼ŒåŒ…æ‹¬ EKS é›†ç¾¤æ§åˆ¶é¢ã€èŠ‚ç‚¹ç»„ä»¥åŠ VPC ç­‰ç½‘ç»œåŸºç¡€æ¶æ„ã€‚ç”±äºä½¿ç”¨äº† `-auto-approve`ï¼Œå‘½ä»¤å°†ç›´æ¥æ‰§è¡Œé”€æ¯ï¼Œæ— éœ€äº¤äº’ç¡®è®¤ã€‚

     *é¢„æœŸè¾“å‡º*: å®Œå…¨é”€æ¯å®Œæˆåï¼ŒTerraform å°†æç¤ºæ‰€æœ‰èµ„æºåˆ é™¤å®Œæ¯•ï¼Œä¾‹å¦‚ï¼š`Destroy complete! Resources: 30 destroyed.`ã€‚æ­¤æ—¶åœ¨ AWS æ§åˆ¶å°åº”çœ‹ä¸åˆ°ä¸å®éªŒç›¸å…³çš„ä»»ä½•èµ„æºã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨äº†è¿œç«¯ S3 åç«¯ï¼ŒTerraform çŠ¶æ€æ–‡ä»¶æœ¬èº«ä¼šä¿ç•™åœ¨çŠ¶æ€åç«¯ä¸­ï¼Œä½†å…¶ä¸­å·²ä¸å†æœ‰ä»»ä½•èµ„æºè®°å½•ã€‚

     **è¯·æ³¨æ„**ï¼šå®Œå…¨é”€æ¯åï¼Œä¸‹æ¬¡é‡å»ºå‰éœ€è¦é‡æ–°æ‰§è¡Œ `terraform init` åˆå§‹åŒ–ï¼Œä»¥ç¡®ä¿ Terraform èƒ½æ­£ç¡®è¿æ¥è¿œç«¯åç«¯å¹¶é‡æ–°åˆ›å»ºæ‰€éœ€èµ„æºï¼ˆç”±äºçŠ¶æ€æ–‡ä»¶æ¸…ç©ºåï¼ŒTerraform æœ¬åœ°å¯èƒ½éœ€è¦é‡æ–°è·å–åç«¯é…ç½®ï¼‰ã€‚

ğŸ’¡ **æˆæœ¬ä¼˜åŒ–æç¤º**ï¼šå¯¹äºæ¯æ—¥ä»…å…³é—­éƒ¨åˆ†èµ„æºçš„åœºæ™¯ï¼Œå¦‚æœæƒ³è¿›ä¸€æ­¥èŠ‚çœæˆæœ¬ï¼Œå¯è€ƒè™‘åœ¨å¤œé—´åœç”¨æ—¶å¯¹ EKS é›†ç¾¤é‡‡å–é¢å¤–æªæ–½ã€‚ä¾‹å¦‚ï¼Œå°†èŠ‚ç‚¹ç»„å®ä¾‹æ•°ç¼©å®¹è‡³ 0ï¼ˆå¦‚æœç™½å¤©æœªè‡ªåŠ¨ç¼©å®¹ï¼‰å¯ç¡®ä¿æ²¡æœ‰ EC2 å®ä¾‹åœ¨å¤œé—´è¿è¡Œã€‚æœ¬é¡¹ç›®æä¾›äº†è¾…åŠ©è„šæœ¬ `scripts/scale-nodegroup-zero.sh` å®ç°ä¸€é”®å°†èŠ‚ç‚¹ç»„ç¼©å®¹è‡³0çš„åŠŸèƒ½ï¼Œå¯å°†å…¶é›†æˆåˆ°é”€æ¯æµç¨‹ä¸­ä½œä¸ºé™„åŠ æ­¥éª¤ã€‚æ­¤å¤–ï¼Œå¦‚æœç¡®å®šæ¯æ™šéƒ½ä¸ä½¿ç”¨é›†ç¾¤ï¼Œä¹Ÿå¯è€ƒè™‘ä½¿ç”¨ `make stop-hard` å®ç°â€œç¡¬åœæœºâ€ï¼šè¯¥å‘½ä»¤åœ¨ `make stop` åŸºç¡€ä¸Šé¢å¤–åˆ é™¤äº† EKS æ§åˆ¶é¢ï¼Œé€‚ç”¨äºè¿ç»­å¤šæ—¥ä¸ä½¿ç”¨ç¯å¢ƒçš„æƒ…å½¢ã€‚è¯·æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„é”€æ¯ç¨‹åº¦ï¼Œåœ¨æˆæœ¬ä¼˜åŒ–ä¸ç¬¬äºŒå¤©çš„é‡å»ºæ—¶é—´ä¹‹é—´å–å¾—å¹³è¡¡ã€‚

### å¸¸è§é”™è¯¯ä¸æ’æŸ¥æŒ‡å¼• (Common Errors & Troubleshooting)

* **èµ„æºä¾èµ–å¯¼è‡´çš„é”€æ¯å¤±è´¥**ï¼šæ‰§è¡Œ `make stop` æˆ– Terraform é”€æ¯æ—¶ï¼Œå¯èƒ½é‡åˆ°å› ä¸ºèµ„æºä¾èµ–é¡ºåºå¯¼è‡´çš„é”™è¯¯ã€‚ä¾‹å¦‚ï¼ŒNAT ç½‘å…³æœ‰æ—¶éœ€è¦ç­‰å¾…å…³è”çš„ç½‘ç»œæ¥å£é‡Šæ”¾æ‰å¯å®Œå…¨åˆ é™¤ã€‚å¦‚æœ Terraform é”€æ¯è¿‡ç¨‹å‡ºç°è¶…æ—¶æˆ–ä¾èµ–é”™è¯¯ï¼Œå¯å°è¯•å†æ¬¡è¿è¡Œé”€æ¯å‘½ä»¤ã€‚å¦‚å¤šæ¬¡é‡è¯•ä»å¤±è´¥ï¼Œç™»å½• AWS æ§åˆ¶å°æ£€æŸ¥ç›¸å…³èµ„æºçŠ¶æ€ï¼šç¡®ä¿ NAT ç½‘å…³å·²å˜ä¸º *deleted* çŠ¶æ€ï¼ŒElastic IP æ˜¯å¦ä»åˆ†é…ç­‰ã€‚å¿…è¦æ—¶å¯æ‰‹åŠ¨é‡Šæ”¾æœªè‡ªåŠ¨åˆ é™¤çš„èµ„æºï¼ˆä¾‹å¦‚ä»ç»‘å®šçš„å¼¹æ€§ç½‘å¡ï¼‰ï¼Œç„¶åå†æ‰§è¡Œ Terraform é”€æ¯ã€‚

* **AWS å‡­è¯é—®é¢˜**ï¼šä¸æ—©æ™¨æ­¥éª¤ç±»ä¼¼ï¼Œè‹¥é”€æ¯è¿‡ç¨‹ä¸­é‡åˆ°æƒé™ç›¸å…³é”™è¯¯ï¼ˆä¾‹å¦‚ AWS API è°ƒç”¨å¤±è´¥ï¼‰ï¼Œè¯·ç¡®è®¤ AWS SSO ç™»å½•æ˜¯å¦ä»åœ¨æœ‰æ•ˆæœŸå†…ã€‚å¦‚æœè‡ªåŠ¨è°ƒç”¨çš„ `aws sso login` æœªæˆåŠŸï¼Œå»ºè®®æ‰‹åŠ¨é‡æ–°ç™»å½•åå†æ‰§è¡Œé”€æ¯æ“ä½œã€‚

* **EKS é›†ç¾¤åˆ é™¤ç¼“æ…¢ (Cluster Deletion Slowness)**ï¼šå¦‚æœé€‰æ‹©æ‰§è¡Œäº†åŒ…å« EKS é›†ç¾¤åˆ é™¤çš„é”€æ¯æ“ä½œï¼Œæœ‰æ—¶åˆ é™¤è¿‡ç¨‹å¯èƒ½è¾ƒé•¿ã€‚å°¤å…¶å½“é›†ç¾¤å†…ä»æœ‰è‡ªå®šä¹‰çš„é™„åŠ ç»„ä»¶æˆ–æ®‹ç•™çš„è´Ÿè½½å‡è¡¡ã€å¼¹æ€§ç½‘å¡ç­‰èµ„æºæ—¶ï¼ŒTerraform åˆ é™¤å¯èƒ½å¡é¡¿ã€‚æ­¤æ—¶å¯åœ¨ AWS æ§åˆ¶å°æŸ¥çœ‹é›†ç¾¤åˆ é™¤è¿›åº¦ï¼Œå¹¶æ£€æŸ¥ CloudFormation æ˜¯å¦å­˜åœ¨æœªåˆ é™¤çš„æ ˆï¼ˆä¾‹å¦‚ `eksctl-dev-cluster` ç­‰æ—§æ ˆï¼‰ã€‚å¿…è¦æ—¶æ‰‹åŠ¨æ¸…ç†ç›¸å…³èµ„æºï¼Œç„¶åå†æ¬¡æ‰§è¡Œ Terraform é”€æ¯ã€‚

å®Œæˆä¸Šè¿°å¤œé—´å…³åœæµç¨‹åï¼Œç¯å¢ƒä¾¿ä»…å‰©ä¸‹ä¸è®¡è´¹æˆ–ä½æˆæœ¬çš„åŸºç¡€éƒ¨åˆ†ï¼ˆå¦‚ VPC ç­‰ï¼‰ã€‚ç¬¬äºŒå¤©æ—©æ™¨å³å¯æŒ‰ç…§å‰è¿°æ­¥éª¤ï¼Œé€šè¿‡ Terraform ä¸€é”®é‡å»ºæ‰€æœ‰èµ„æºï¼Œå®ç°å®Œæ•´çš„**ä¸€é”®é”€æ¯ä¸é‡å»º**å¾ªç¯ï¼Œè€Œæ— éœ€é¢å¤–æ‰‹åŠ¨å¹²é¢„ EKS é›†ç¾¤ã€‚æœ¬æŒ‡å—ç¡®ä¿ç”¨æˆ·æ¯æ—¥éƒ½èƒ½å®Œå…¨ä¾èµ– Terraform ç®¡ç†åŸºç¡€è®¾æ–½ï¼Œå®ç°æˆæœ¬æœ€ä¼˜åŒ–å’Œæ“ä½œç®€ä¾¿åŒ–ã€‚

## âœ… é”€æ¯æ¸…å•éªŒè¯ (Evening Checklist)

* âœ… **Terraform çŠ¶æ€å­˜å‚¨ä¿ç•™ (State bucket retained)**ï¼š
  `aws s3 ls s3://phase2-tf-state-us-east-1 --profile phase2-sso` å¯çœ‹åˆ°çŠ¶æ€æ–‡ä»¶ã€‚
* âœ… **VPC ä¸å­ç½‘ä¿ç•™ (VPC & subnets retained)**ï¼š
  `aws ec2 describe-vpcs --region us-east-1 --profile phase2-sso` åŠ `aws ec2 describe-subnets` ä»ä¼šåˆ—å‡ºç½‘ç»œèµ„æºã€‚
* âŒ **NAT ç½‘å…³å·²åˆ é™¤ (NAT Gateway removed)**ï¼š
  `aws ec2 describe-nat-gateways --region us-east-1 --profile phase2-sso` åº”è¿”å›ç©ºåˆ—è¡¨æˆ–çŠ¶æ€ä¸º `deleted`ã€‚
* âŒ **ALB å·²åˆ é™¤ (ALB removed)**ï¼š
  è¿è¡Œ `aws elbv2 describe-load-balancers --region us-east-1 --profile phase2-sso` ä¸å†åŒ…å«å®éªŒè´Ÿè½½å‡è¡¡ã€‚
* âŒ **EKS é›†ç¾¤çŠ¶æ€ (EKS cluster state)**ï¼š
  å¦‚æ‰§è¡Œ `make stop-hard`ï¼Œ`aws eks list-clusters --region us-east-1 --profile phase2-sso` ä¸­ä¸åº”å‡ºç°é›†ç¾¤åç§°ï¼›è‹¥ä»…æ‰§è¡Œ `make stop`ï¼Œé›†ç¾¤ä¾æ—§å­˜åœ¨ä½†å·¥ä½œèŠ‚ç‚¹åº”å·²ç¼©å®¹è‡³ 0ã€‚
* âŒ **Spot é€šçŸ¥è§£ç»‘ (Spot notification unsubscribed)**ï¼š
  `post-teardown.sh` ä¼šè‡ªåŠ¨æ£€æŸ¥ ASG æ˜¯å¦ä»ç»‘å®šé€šçŸ¥ï¼Œä¹Ÿå¯åœ¨ SNS æ§åˆ¶å°ç¡®è®¤ã€‚
* âŒ **CloudWatch -> Log Group å·²ç»åˆ é™¤ã€‚**

è‹¥ä¸Šè¿°é¡¹ç›®å‡ç¬¦åˆé¢„æœŸï¼Œå³è¡¨ç¤ºå¤œé—´é”€æ¯æµç¨‹é¡ºåˆ©å®Œæˆã€‚è‹¥å‘ç°æœªåˆ é™¤çš„èµ„æºï¼Œå¯é‡æ–°è¿è¡Œ Terraform æˆ–æ£€æŸ¥æ—¥å¿—æ’æŸ¥åŸå› ã€‚
